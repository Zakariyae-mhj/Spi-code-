// استيراد ملف SHP من Assets
var region = ee.FeatureCollection('users/Zakariyae_mahj/mouLouya_moyenne');

// تحميل بيانات التساقطات من CHIRPS
var chirps = ee.ImageCollection('UCSB-CHG/CHIRPS/DAILY')
  .filterDate('2000-01-01', '2024-12-31')
  .select('precipitation');

// دالة لحساب SPI لكل سنة
var computeSPI = function(year) {
  year = ee.Number(year);

  // تصفية بيانات التساقطات لهذه السنة
  var yearlyRainfall = chirps.filterDate(
    ee.Date.fromYMD(year, 1, 1), ee.Date.fromYMD(year, 12, 31))
    .reduce(ee.Reducer.sum()).rename('annual_precipitation');

  // حساب المتوسط والانحراف المعياري داخل مجال الدراسة
  var stats = yearlyRainfall.reduceRegion({
    reducer: ee.Reducer.mean().combine({
      reducer2: ee.Reducer.stdDev(),
      sharedInputs: true
    }),
    geometry: region.geometry(),
    scale: 5000,
    bestEffort: true
  });

  var meanRainfall = ee.Number(stats.get('annual_precipitation_mean'));
  var stdDevRainfall = ee.Number(stats.get('annual_precipitation_stdDev'));

  // حساب SPI لهذه السنة
  var spi = yearlyRainfall.subtract(meanRainfall).divide(stdDevRainfall)
    .rename('SPI_' + year.format('%d'))
    .set('year', year);

  return spi;
};

// إنشاء قائمة بالسنوات من 2000 إلى 2024
var years = ee.List.sequence(2000, 2024);

// حساب SPI لكل سنة وإنشاء مجموعة صور
var spiCollection = ee.ImageCollection(years.map(computeSPI));

// تكبير الخريطة على مجال الدراسة
Map.centerObject(region, 6);

// عرض SPI لكل سنة على الخريطة
years.evaluate(function(yearsList) {
  yearsList.forEach(function(year) {
    var spiImage = spiCollection.filter(ee.Filter.eq('year', year)).first();
    Map.addLayer(spiImage.clip(region), 
      {min: -2, max: 2, palette: ['red', 'yellow', 'green']}, 
      'SPI ' + year);

    // تصدير SPI إلى Google Drive
    Export.image.toDrive({
      image: spiImage.clip(region),
      description: 'SPI_' + year,
      folder: 'SPI_Results',
      fileNamePrefix: 'SPI_' + year,
      scale: 5000,
      region: region.geometry(),
      maxPixels: 1e13,
      fileFormat: 'GeoTIFF'
    });
  });
});
